<!-- Generated by SpecStory -->

# Enhancing Question Node UI and Button Behavior (2025-04-02 10:12:21)

_**User**_

Update the question nodes to make it so the node is large enough that the 'answer' button does not cover the 'question' text. Update the answer button to provide a visual indicator that it has been pressed (whilst waiting for the answer). Perhaps change its text from 'answer' to 'answering' and make the button color green. I still want the button to disappear once the answer node is created and started to be populated with text.

Here is some preliminary info:
@fadeout-text.css @FadeoutTextNode.tsx @GraphPage.tsx 
1.  **Modify Question Node Appearance/Layout:** The task involves changing how the question node (`FadeoutTextNode` of type 'question') renders, specifically its size/padding to accommodate the button and the button's appearance itself.
    *   `app/src/FadeoutTextNode.tsx`: This file defines the custom React Flow node component. It contains the rendering logic for both question and answer nodes, including the "Answer" button, its styling, and the node's padding/height calculations. This is the primary file for visual changes to the node and button.
    *   `app/src/fadeout-text.css`: This file contains custom CSS for the `FadeoutTextNode`. While Tailwind is used, some layout adjustments or styles might potentially touch this file, although changes within the TSX component are more likely.

2.  **Manage Button State (Loading/Answering):** The button needs to visually indicate when its action (`generateAnswerForNode`) is in progress. This requires managing and passing down a loading state for individual nodes.
    *   `app/src/GraphPage.tsx`: This file contains the `generateAnswerForNode` function which is triggered by the button click. It also manages the main state (`resultTree`, `qaTreeRef`) and converts the tree data into nodes/edges via `convertTreeToFlow`. This file will need modification to:
        *   Track the "answering" state for specific nodes *during* the execution of `generateAnswerForNode`.
        *   Pass this state information down to the `FadeoutTextNode` component, likely by modifying the `data` object created within `convertTreeToFlow`.
    *   `app/src/FadeoutTextNode.tsx`: Needs to receive the new "answering" state via its `props.data` and use it to conditionally change the button's text and background color.



---

_**Assistant**_

Okay, I understand the requirements. I'll modify the `GraphPage` and `FadeoutTextNode` components to implement the button loading state and ensure the button doesn't overlap the text.

First, I'll update `GraphPage.tsx` to track which nodes are currently being answered.



---

```diff
    deleteBranch: any,
    playing: boolean,
-   generateAnswerForNode: (nodeId: string) => Promise<void>
+   generateAnswerForNode: (nodeId: string) => Promise<void>,
+   answeringNodes: Set<string>
  ) => any;
  
    deleteBranch,
    playing,
-   generateAnswerForNode
+   generateAnswerForNode,
+   answeringNodes
  ) => {
    const nodes: TreeNode[] = [];
          hasAnswer: !!tree[key].answer,
          onGenerateAnswer: generateAnswerForNode,
+         isAnswering: answeringNodes.has(key),
        },
        position: { x: 0, y: 0 },
    const [fullyPaused, setFullyPaused] = useState(false);
    const initialGenerationPaused = useRef(false);
+   const [answeringNodes, setAnsweringNodes] = useState<Set<string>>(new Set());
  
    const generateAnswerForNode = useCallback(
      async (nodeId: string) => {
        console.log("Manual trigger for node:", nodeId);
-       const node = qaTreeRef.current[nodeId];
-       if (!node || node.answer) {
-         console.warn(`Node ${nodeId} not found or already has answer.`);
-         return;
-       }
+       setAnsweringNodes(prev => new Set(prev).add(nodeId));
+       try {
+         const node = qaTreeRef.current[nodeId];
+         if (!node || node.answer) {
+           console.warn(`Node ${nodeId} not found or already has answer.`);
+           return;
+         }
  
-       node.startedProcessing = true;
-       setResultTree(JSON.parse(JSON.stringify(qaTreeRef.current)));
+         node.startedProcessing = true;
+         setResultTree(JSON.parse(JSON.stringify(qaTreeRef.current)));
  
-       const commonOpts = {
-         apiKey: props.apiKey,
-         model: props.model,
-         persona: props.persona,
-         qaTree: qaTreeRef.current,
-       };
+         const commonOpts = {
+           apiKey: props.apiKey,
+           model: props.model,
+           persona: props.persona,
+           qaTree: qaTreeRef.current,
+         };
  
-       try {
          const promptForAnswer = PERSONAS[commonOpts.persona].getPromptForAnswer(
            node,
            setResultTree(JSON.parse(JSON.stringify(qaTreeRef.current)));
          }
+       } finally {
+          setAnsweringNodes(prev => {
+            const next = new Set(prev);
+            next.delete(nodeId);
+            return next;
+          });
        }
      },
  
    const { nodes, edges } = useMemo(() => {
-     return convertTreeToFlow(resultTree, setNodeDims, deleteBranch, playing, generateAnswerForNode);
-   }, [resultTree, playing]);
+     return convertTreeToFlow(resultTree, setNodeDims, deleteBranch, playing, generateAnswerForNode, answeringNodes);
+   }, [resultTree, playing, answeringNodes, generateAnswerForNode]);
  
    function resume() {
```

---

OK, I've updated `GraphPage.tsx` to track the loading state for each node when the "Answer" button is clicked.

Now, I'll modify `FadeoutTextNode.tsx` to:
1.  Use the new `isAnswering` prop to change the button's appearance (text, color) and disable it during loading.
2.  Adjust the bottom padding on the question node container to ensure the button doesn't overlap the text.



---

```diff
      hasAnswer?: boolean;
      onGenerateAnswer?: (nodeId: string) => void;
+     isAnswering?: boolean;
    };
  };
          maxWidth: 250,
          overflow: "hidden",
-         height: props.data.question
+         height: props.data.question && !props.data.hasAnswer
            ? expanded
              ? actualHeight + 16 + 2
-             : Math.min(140 + 16 + 2, actualHeight + 16 + 2)
-           : "auto",
+             : Math.min(140, actualHeight) + 16 + 2 + 28
+           : expanded
+             ? actualHeight + 16 + 2
+             : props.data.question
+               ? Math.min(140 + 16 + 2, actualHeight + 16 + 2)
+               : "auto",
          transition:
            "transform 0.5s, height 0.5s, width 0.5s, opacity 0.15s, border 0.15s",
-         paddingBottom: props.data.question && !props.data.hasAnswer ? "28px" : "8px",
+         paddingBottom: props.data.question && !props.data.hasAnswer ? "36px" : "8px",
        }}
      >
        {props.data.question && !props.data.hasAnswer && props.data.onGenerateAnswer && (
          <button
+           disabled={props.data.isAnswering}
            onClick={(e) => {
              e.stopPropagation();
              }
            }}
-           className="absolute bottom-1 right-1 bg-sky-600 text-white px-2 py-0.5 rounded text-xs hover:bg-sky-700 z-10 cursor-pointer"
+           className={classNames(
+             "absolute bottom-1 right-1 text-white px-2 py-0.5 rounded text-xs z-10",
+             {
+               "bg-green-600 hover:bg-green-700 cursor-wait": props.data.isAnswering,
+               "bg-sky-600 hover:bg-sky-700 cursor-pointer": !props.data.isAnswering,
+             }
+           )}
            style={{ fontSize: '0.7rem', lineHeight: '1rem', padding: '2px 6px'}}
          >
-           Answer
+           {props.data.isAnswering ? "Answering..." : "Answer"}
          </button>
        )}
```

---

I've updated `FadeoutTextNode.tsx`. The "Answer" button should now change to "Answering...", turn green, and be disabled while the answer is being generated. I've also increased the bottom padding on the question node to prevent the button from overlapping the text.

Please test these changes and let me know if they work as expected or if any further adjustments are needed.

---



---



---

